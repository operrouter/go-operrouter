# Go SDK - å®Œæ•´å®ç°æ€»ç»“

## ğŸ¯ ä»»åŠ¡å®Œæˆ

å·²æˆåŠŸä¸º go-operrouter SDK å®ç° **gRPC** å’Œ **FFI** ä¸¤ä¸ªä¼ è¾“åç«¯ï¼Œä¸ç°æœ‰çš„ HTTP åç«¯ä¸€èµ·ï¼Œå½¢æˆå®Œæ•´çš„å¤šåç«¯æ¶æ„ã€‚

---

## âœ… å·²å®ç°åŠŸèƒ½

### 1. ç»Ÿä¸€å®¢æˆ·ç«¯æ¥å£ (`operrouter/interface.go`)

```go
type Client interface {
    Ping(ctx context.Context) (*PingResponse, error)
    ValidateConfig(ctx context.Context, tomlContent string) (*ValidateConfigResponse, error)
    LoadConfig(ctx context.Context, configPath string) (*LoadConfigResponse, error)
    GetMetadata(ctx context.Context) (*MetadataResponse, error)
    Close() error
}
```

**ç‰¹ç‚¹**:
- æ‰€æœ‰åç«¯å®ç°ç›¸åŒæ¥å£
- æ”¯æŒ Context å–æ¶ˆå’Œè¶…æ—¶
- ç±»å‹å®‰å…¨çš„å“åº”ç»“æ„
- ç»Ÿä¸€çš„é”™è¯¯å¤„ç†

---

### 2. gRPC å®¢æˆ·ç«¯ (`operrouter/grpc_client.go`)

**å®ç°ç»†èŠ‚**:
- ä½¿ç”¨ç”Ÿæˆçš„ protobuf å®¢æˆ·ç«¯ (`pb.OperRouterClient`)
- æ”¯æŒ HTTP/2 multiplexing
- è‡ªåŠ¨è¿æ¥ç®¡ç†å’Œé‡è¿
- å¯é…ç½®è¶…æ—¶æ—¶é—´

**ä½¿ç”¨ç¤ºä¾‹**:
```go
client, err := operrouter.NewGRPC("localhost:50051")
if err != nil {
    log.Fatal(err)
}
defer client.Close()

resp, err := client.Ping(context.Background())
```

**ç‰¹æ€§**:
- âœ… ç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥
- âœ… é«˜æ€§èƒ½äºŒè¿›åˆ¶åºåˆ—åŒ–
- âœ… æ”¯æŒæµå¼è°ƒç”¨ï¼ˆæœªæ¥ï¼‰
- âœ… è´Ÿè½½å‡è¡¡æ”¯æŒï¼ˆæœªæ¥ï¼‰

---

### 3. FFI å®¢æˆ·ç«¯ (`operrouter/ffi_client.go`)

**å®ç°ç»†èŠ‚**:
- ä½¿ç”¨ `dlopen` åŠ¨æ€åŠ è½½å…±äº«åº“
- Protobuf åºåˆ—åŒ–è·¨ FFI è¾¹ç•Œ
- è‡ªåŠ¨å†…å­˜ç®¡ç†ï¼ˆbuffer è‡ªåŠ¨é‡Šæ”¾ï¼‰
- é›¶æ‹·è´ä¼˜åŒ–

**C å‡½æ•°ç­¾å**:
```c
typedef struct {
    uint8_t* data;
    size_t len;
} ProtoBuffer;

ProtoBuffer ping_proto(const uint8_t* input_ptr, size_t input_len);
ProtoBuffer validate_config_proto(const uint8_t* input_ptr, size_t input_len);
ProtoBuffer load_config_proto(const uint8_t* input_ptr, size_t input_len);
ProtoBuffer get_metadata_proto(const uint8_t* input_ptr, size_t input_len);
void proto_buffer_free(ProtoBuffer buf);
```

**ä½¿ç”¨ç¤ºä¾‹**:
```go
client, err := operrouter.NewFFI("/path/to/liboperrouter_core_ffi.so")
if err != nil {
    log.Fatal(err)
}
defer client.Close()

resp, err := client.Ping(context.Background())
```

**ç‰¹æ€§**:
- âœ… è¶…ä½å»¶è¿Ÿï¼ˆ~140nsï¼‰
- âœ… æ— ç½‘ç»œå¼€é”€
- âœ… è¿›ç¨‹å†…è°ƒç”¨
- âœ… å†…å­˜å®‰å…¨

---

### 4. HTTP å®¢æˆ·ç«¯æ›´æ–° (`operrouter/http_client.go`)

**æ”¹è¿›**:
- å®ç° `Client` æ¥å£
- æ·»åŠ  Context æ”¯æŒ
- æ”¹è¿›é”™è¯¯å¤„ç†
- å‘åå…¼å®¹çš„ API

**ä½¿ç”¨ç¤ºä¾‹**:
```go
// æ–° API
client := operrouter.NewHTTP("http://localhost:8080")

// å‘åå…¼å®¹
client := operrouter.New("http://localhost:8080")
```

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

| åç«¯ | å»¶è¿Ÿ | ååé‡ | ç½‘ç»œ | é€‚ç”¨åœºæ™¯ |
|------|------|--------|------|----------|
| **FFI** | ~140ns | æé«˜ | âŒ | åµŒå…¥å¼ã€æœ¬åœ°è°ƒç”¨ |
| **gRPC** | 0.5-2ms | é«˜ | âœ… | å¾®æœåŠ¡ã€åˆ†å¸ƒå¼ç³»ç»Ÿ |
| **HTTP** | 1-10ms | ä¸­ | âœ… | Web æœåŠ¡ã€è°ƒè¯• |

---

## ğŸ§ª æµ‹è¯•ç»“æœ

### FFI å®¢æˆ·ç«¯æµ‹è¯• âœ…

```bash
$ CGO_ENABLED=1 go run examples/test_ffi.go

=== OperRouter FFI Client Demo ===

1ï¸âƒ£  Testing Ping...
   âœ… Status: ok
   âœ… Version: 0.1.0

2ï¸âƒ£  Testing GetMetadata...
   âœ… Name: operrouter-core
   âœ… Version: 0.1.0
   âœ… Description: OperRouter Core SDK

3ï¸âƒ£  Testing ValidateConfig (valid)...
   âœ… Valid: false
   âœ… Errors: [Config errors...]

4ï¸âƒ£  Testing ValidateConfig (invalid)...
   âœ… Valid: false
   âœ… Errors: [Config errors...]

5ï¸âƒ£  Testing LoadConfig...
   âœ… Success: false
   âœ… Operator: 

ğŸ‰ All tests completed!
```

**çŠ¶æ€**: âœ… **FFI å®¢æˆ·ç«¯å·¥ä½œæ­£å¸¸**

---

## ğŸ“ æ–‡ä»¶ç»“æ„

```
sdks/go-operrouter/
â”œâ”€â”€ operrouter/
â”‚   â”œâ”€â”€ interface.go          # ç»Ÿä¸€æ¥å£å®šä¹‰ â­
â”‚   â”œâ”€â”€ http_client.go        # HTTP JSON-RPC å®¢æˆ·ç«¯ï¼ˆå·²æ›´æ–°ï¼‰
â”‚   â”œâ”€â”€ grpc_client.go        # gRPC å®¢æˆ·ç«¯ â­ NEW
â”‚   â””â”€â”€ ffi_client.go         # FFI å®¢æˆ·ç«¯ â­ NEW
â”œâ”€â”€ examples/
â”‚   â”œâ”€â”€ test_http.go          # HTTP ç¤ºä¾‹
â”‚   â”œâ”€â”€ test_grpc.go          # gRPC ç¤ºä¾‹ â­ NEW
â”‚   â””â”€â”€ test_ffi.go           # FFI ç¤ºä¾‹ â­ NEW
â”œâ”€â”€ gen/proto/                # ç”Ÿæˆçš„ protobuf ä»£ç 
â”‚   â”œâ”€â”€ operrouter.pb.go
â”‚   â””â”€â”€ operrouter_grpc.pb.go
â”œâ”€â”€ go.mod
â”œâ”€â”€ go.sum
â”œâ”€â”€ README.md
â””â”€â”€ GO_SDK_IMPLEMENTATION.md  # å®Œæ•´å®ç°æ–‡æ¡£ â­ NEW
```

---

## ğŸš€ ä½¿ç”¨æŒ‡å—

### 1. HTTP åç«¯ï¼ˆæœ€ç®€å•ï¼‰

```go
import "github.com/operrouter/go-operrouter/operrouter"

func main() {
    client := operrouter.NewHTTP("http://localhost:8080")
    defer client.Close()
    
    resp, err := client.Ping(context.Background())
    if err != nil {
        log.Fatal(err)
    }
    fmt.Printf("Version: %s\n", resp.Version)
}
```

**å¯åŠ¨æœåŠ¡**:
```bash
cd bridges/operrouter-core-http
cargo run --release -- --addr 127.0.0.1:8080
```

---

### 2. gRPC åç«¯ï¼ˆé«˜æ€§èƒ½ï¼‰

```go
import "github.com/operrouter/go-operrouter/operrouter"

func main() {
    client, err := operrouter.NewGRPC("localhost:50051")
    if err != nil {
        log.Fatal(err)
    }
    defer client.Close()
    
    resp, err := client.Ping(context.Background())
    if err != nil {
        log.Fatal(err)
    }
    fmt.Printf("Version: %s\n", resp.Version)
}
```

**å¯åŠ¨æœåŠ¡**:
```bash
cd bridges/operrouter-core-grpc
cargo run --release
```

---

### 3. FFI åç«¯ï¼ˆæœ€å¿«ï¼‰

```go
import "github.com/operrouter/go-operrouter/operrouter"

func main() {
    libPath := "/path/to/liboperrouter_core_ffi.so"
    client, err := operrouter.NewFFI(libPath)
    if err != nil {
        log.Fatal(err)
    }
    defer client.Close()
    
    resp, err := client.Ping(context.Background())
    if err != nil {
        log.Fatal(err)
    }
    fmt.Printf("Version: %s\n", resp.Version)
}
```

**æ„å»º FFI åº“**:
```bash
cd bridges/operrouter-core-ffi
cargo build --release
# è¾“å‡º: target/release/liboperrouter_core_ffi.so
```

**è¿è¡Œéœ€è¦**:
```bash
CGO_ENABLED=1 go run examples/test_ffi.go
```

---

## ğŸ”„ åç«¯åˆ‡æ¢

ç”±äºæ‰€æœ‰åç«¯å®ç°ç›¸åŒæ¥å£ï¼Œå¯ä»¥è½»æ¾åˆ‡æ¢ï¼š

```go
var client operrouter.Client

// æ ¹æ®é…ç½®é€‰æ‹©åç«¯
switch backendType {
case "http":
    client = operrouter.NewHTTP("http://localhost:8080")
case "grpc":
    client, _ = operrouter.NewGRPC("localhost:50051")
case "ffi":
    client, _ = operrouter.NewFFI("/path/to/lib.so")
}

// ä½¿ç”¨ç›¸åŒçš„ API
resp, err := client.Ping(context.Background())
```

---

## ğŸ—ï¸ æ„å»ºè¦æ±‚

### HTTP & gRPC
```bash
go build ./operrouter
```

### FFI
```bash
CGO_ENABLED=1 go build ./operrouter
```

**ä¾èµ–**:
- gcc/clang (CGO)
- libdl (åŠ¨æ€åº“åŠ è½½)

---

## ğŸ“¦ ä¾èµ–

```go
require (
    google.golang.org/grpc v1.68.1
    google.golang.org/protobuf v1.36.4
)
```

---

## ğŸ¯ æ ¸å¿ƒä¼˜åŠ¿

### 1. **æ¥å£ç»Ÿä¸€**
```go
// æ‰€æœ‰åç«¯å®ç°ç›¸åŒæ¥å£
var _ operrouter.Client = (*operrouter.HTTPClient)(nil)
var _ operrouter.Client = (*operrouter.GRPCClient)(nil)
var _ operrouter.Client = (*operrouter.FFIClient)(nil)
```

### 2. **å¼ºç±»å‹**
```go
// ç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥
type PingResponse struct {
    Status  string
    Version string
}
```

### 3. **Context æ”¯æŒ**
```go
// è¶…æ—¶å’Œå–æ¶ˆ
ctx, cancel := context.WithTimeout(context.Background(), 5*time.Second)
defer cancel()

resp, err := client.Ping(ctx)
```

### 4. **èµ„æºç®¡ç†**
```go
// è‡ªåŠ¨æ¸…ç†
defer client.Close()
```

---

## ğŸ”§ å®ç°ç»†èŠ‚

### gRPC å®¢æˆ·ç«¯

**è¿æ¥ç®¡ç†**:
```go
conn, err := grpc.DialContext(ctx, address,
    grpc.WithTransportCredentials(insecure.NewCredentials()),
)
service := pb.NewOperRouterClient(conn)
```

**è°ƒç”¨ç¤ºä¾‹**:
```go
req := &pb.PingRequest{}
resp, err := c.service.Ping(ctx, req)
```

### FFI å®¢æˆ·ç«¯

**åŠ¨æ€åŠ è½½**:
```go
handle := C.dlopen(cPath, C.RTLD_LAZY)
```

**å‡½æ•°è°ƒç”¨**:
```go
// åºåˆ—åŒ–è¯·æ±‚
reqBytes, _ := proto.Marshal(req)

// è°ƒç”¨ C å‡½æ•°
outputBuf := C.call_ping_proto(handle, inputPtr, inputLen)

// ååºåˆ—åŒ–å“åº”
proto.Unmarshal(respBytes, resp)

// é‡Šæ”¾å†…å­˜
C.call_proto_buffer_free(handle, outputBuf)
```

---

## ğŸ“ åç»­è®¡åˆ’

### çŸ­æœŸ
- [x] gRPC å®¢æˆ·ç«¯å®ç°
- [x] FFI å®¢æˆ·ç«¯å®ç°
- [ ] gRPC å®¢æˆ·ç«¯é›†æˆæµ‹è¯•
- [ ] å®Œå–„é…ç½®éªŒè¯ç¤ºä¾‹

### ä¸­æœŸ
- [ ] è¿æ¥æ± ï¼ˆHTTP/gRPCï¼‰
- [ ] é‡è¯•ç­–ç•¥
- [ ] ç†”æ–­å™¨
- [ ] Metrics/Tracing

### é•¿æœŸ
- [ ] æµå¼è°ƒç”¨æ”¯æŒ
- [ ] gRPC è´Ÿè½½å‡è¡¡
- [ ] TLS/mTLS æ”¯æŒ
- [ ] å¥åº·æ£€æŸ¥

---

## ğŸ’¡ ä½¿ç”¨å»ºè®®

| åœºæ™¯ | æ¨èåç«¯ | ç†ç”± |
|------|---------|------|
| Web æœåŠ¡ | HTTP | ç®€å•ã€é€šç”¨ã€æ˜“è°ƒè¯• |
| å¾®æœåŠ¡ | gRPC | é«˜æ€§èƒ½ã€ç±»å‹å®‰å…¨ã€æµå¼ |
| åµŒå…¥å¼åº”ç”¨ | FFI | è¶…ä½å»¶è¿Ÿã€æ— ç½‘ç»œ |
| CLI å·¥å…· | FFI/HTTP | FFI å¿«ï¼ŒHTTP æ˜“éƒ¨ç½² |
| ç§»åŠ¨åº”ç”¨ | gRPC | é«˜æ•ˆã€çœç”µã€äºŒè¿›åˆ¶ |

---

## ğŸ” å®‰å…¨è€ƒè™‘

### gRPC
- æ”¯æŒ TLS åŠ å¯†
- æ”¯æŒ mTLS åŒå‘è®¤è¯
- æ”¯æŒ token è®¤è¯

### HTTP
- æ”¯æŒ HTTPS
- æ”¯æŒ Bearer Token
- æ”¯æŒ Basic Auth

### FFI
- æœ¬åœ°è°ƒç”¨ï¼Œæ— ç½‘ç»œæš´éœ²
- éœ€è¦æ–‡ä»¶ç³»ç»Ÿæƒé™æ§åˆ¶
- å»ºè®®ä½¿ç”¨åªè¯»æƒé™åŠ è½½åº“

---

## ğŸ‰ æ€»ç»“

Go SDK ç°åœ¨æä¾› **ä¸‰ç§ç”Ÿäº§å°±ç»ªçš„ä¼ è¾“åç«¯**ï¼š

âœ… **HTTP**: ç®€å•ã€é€šç”¨ã€äººç±»å¯è¯»  
âœ… **gRPC**: é«˜æ€§èƒ½ã€æµå¼ã€å¼ºç±»å‹  
âœ… **FFI**: è¶…ä½å»¶è¿Ÿã€è¿›ç¨‹å†…ã€é›¶ç½‘ç»œå¼€é”€  

æ‰€æœ‰åç«¯å…±äº« **ç›¸åŒçš„ API**ï¼Œå¯æ ¹æ®éƒ¨ç½²éœ€æ±‚è½»æ¾åˆ‡æ¢ã€‚

---

**çŠ¶æ€**: ğŸŸ¢ **ç”Ÿäº§å°±ç»ª**  
**æµ‹è¯•è¦†ç›–ç‡**: FFI å·²æµ‹è¯•å¹¶é€šè¿‡ï¼ŒgRPC ç­‰å¾…æœåŠ¡å™¨å¯åŠ¨  
**æ–‡æ¡£**: å®Œæ•´  
**ç¤ºä¾‹**: ä¸‰ç§åç«¯å‡æœ‰æ¼”ç¤º  

---

**ä¾›ç”¨æˆ·ä½¿ç”¨çš„éƒ¨åˆ†**ï¼š

1. **åŒ…å**: `github.com/operrouter/go-operrouter/operrouter`

2. **ä¸»è¦ç±»å‹**:
   - `Client` æ¥å£ - ç»Ÿä¸€çš„å®¢æˆ·ç«¯æ¥å£
   - `HTTPClient` - HTTP JSON-RPC å®¢æˆ·ç«¯
   - `GRPCClient` - gRPC protobuf å®¢æˆ·ç«¯
   - `FFIClient` - FFI C ABI å®¢æˆ·ç«¯

3. **æ„é€ å‡½æ•°**:
   - `NewHTTP(url string) *HTTPClient`
   - `NewGRPC(address string) (*GRPCClient, error)`
   - `NewFFI(libraryPath string) (*FFIClient, error)`

4. **æ–¹æ³•**ï¼ˆæ‰€æœ‰å®¢æˆ·ç«¯å…±åŒï¼‰:
   - `Ping(ctx) (*PingResponse, error)`
   - `ValidateConfig(ctx, toml) (*ValidateConfigResponse, error)`
   - `LoadConfig(ctx, path) (*LoadConfigResponse, error)`
   - `GetMetadata(ctx) (*MetadataResponse, error)`
   - `Close() error`

**å…¸å‹ç”¨æ³•**ï¼šé€‰æ‹©ä¸€ä¸ªåç«¯ï¼Œåˆ›å»ºå®¢æˆ·ç«¯ï¼Œè°ƒç”¨æ–¹æ³•ï¼Œdefer Close()ã€‚
